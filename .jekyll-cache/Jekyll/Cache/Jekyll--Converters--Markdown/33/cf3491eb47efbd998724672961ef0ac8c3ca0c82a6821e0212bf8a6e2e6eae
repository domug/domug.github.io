I",&<p><a href="https://domug.github.io/2022/04/25/ABTest_5/">저번 포스트</a>에서는 실험의 결과를 도출하는 과정에서 발생할 수 있는 <strong>다중 검정</strong>의 개념을 정의한 다음, 이를 처리할 수 있는 몇가지 통계적 접근법들에 대해서 살펴보았다. 해당 내용의 연장선상에서, 이번에는 구체적으로 어떠한 경우에 다중 검정에 대한 유의 수준 보정이 필요한지를 정리해보도록 하겠다.</p>

<p>앞서 다중 검정은 그 개념 자체가 다소 생소하기 때문에 A/B Test와 관련한 실무자들에게 그 위험성 자체가 인지되지 않는 경우가 많다는 점을 언급한 적이 있다. 그리고 실제로 optimizely, facebook ads 등의 실험 플랫폼 등에서도 구체적인 p-value를 제시하기 보다는 최종적인 결과 (통계적으로 유의하다 / 유의하지 않다) 만을 UI 상에서 제시하기 때문에, 구체적으로 어떠한 부분에서 다중 검정으로 인한 유의 수준이 보정되는지를 파악하기가 다소 어렵다.</p>

<p>이러한 측면에서 A/B Test를 설계 및 진행함에 있어 어떠한 측면에서 어떻게 다중 검정의 이슈를 핸들링할 수 있는지를 개괄적으로 정리해보려고 한다. 구체적으로 다룰 내용은 다음과 같다:</p>

<ul>
  <li><strong>Metric type</strong></li>
  <li><strong>하위군 분석 (Segment Analysis)</strong></li>
  <li><strong>A/B/n 실험</strong></li>
  <li><strong>조기 종료 (Early Stopping)</strong></li>
</ul>

<p> </p>

<hr />

<h1 id="1-metric-type">1. Metric Type</h1>

<p>이전에 살펴본 Bonferroni 등의 방법을 사용해서 다중검정 문제를 해결하려는 경우, 필연적으로 우리는 더 <strong>낮은 유의수준</strong>에서 가설 검정을 진행하게 된다. 이에 따라 결과적으로 실험의 유의성을 주장하기 위해서는 더 유의한 (낮은) p-value가 요구되기 때문에 실험의 <strong>검정력</strong>을 손해보는 상황이 발생한다. 이와 같은 이유로 Bonferroni 등의 방법은 정말 필요할 때만, <strong>최소한</strong>으로 적용하는 것이 바람직할 것이다. 무분별하게 적용할 경우면 실제로 유의했던 실험들이 기각되는 오류가 발생할 수 있기 때문이다.</p>

<p>이러한 맥락에서 각 지표들을 그 특징에 따라 분류한 다음, 특정한 지표가 실험의 결론에 핵심적인 영향을 미치는지, 또는 단순히 참고용으로만 활용되는지에 따라서 다중 검정에 대한 유의수준 보정이 필요할 수도, 필요하지 않을 수도 있다. 이에 대해 하나씩 살펴보자.</p>

<p> </p>

<h4 id="1차-유효성-평가변수-primary-metric">1차 유효성 평가변수 (Primary Metric)</h4>

<p>OEC(Overall Evaluation Criterion)와 같이 실험을 통해 <strong>인과성을 검증하고자 하는 메인 지표</strong>를 의미한다.</p>

<p>이러한 지표들에 대해서 만큼은 1종 오류가 실험의 계획단계에서 고려된 유의수준보다 절대로 증가해서는 안될 것이다.</p>

<p>보통의 A/B Test에서 1차 유효성 평가변수는 단 한개만 설정되는 것이 일반적이나, 만약 후술할 2차 유효성 평가변수 등에 대한 확증적 결과를 얻으려는 경우 앞서 살펴본 방법론들을 바탕으로 함께 유의수준을 보정해야 할 필요가 있다.</p>

<p> </p>

<h4 id="2차-유효성-평가변수-secondary-metric">2차 유효성 평가변수 (Secondary Metric)</h4>

<p>2차 유효성 평가변수란, 1차 유효성 평가변수에 비해서는 중요도가 떨어지지만 그럼에도 불구하고 관심있게 체크하고 싶은 지표를 의미한다.</p>

<p>일반적으로 이러한 2차 유효성 평가변수에 대해서는 <strong>유의수준을 보정하지 않는 것이 원칙</strong>이나, 그럼에도 불구하고 실험의 유의성을 판단함에 있어 직접적인 고려대상이 되는 경우에는 다중 검정을 보정해야 한다.</p>

<p> </p>

<h4 id="보조-지표-debugging--guardrail-metric">보조 지표 (Debugging &amp; Guardrail Metric)</h4>

<p>Guardrail metric 등의 보조 지표에 대해서는 <strong>유의수준을 보정할 필요가 없다</strong>.</p>

<p>해당 지표들은 실험의 유의성을 판단하는데 있어 직접적인 영향을 미치지 않는, 어디까지나 “부수적인” 지표이기 때문에 1종 오류의 증가에 민감하게 대응할 필요가 없다. 그렇기 때문에 이러한 지표들에 대한 결과는 어디까지나 참고용으로만 활용해야 한다.</p>

<p> </p>

<hr />

<h1 id="2-하위군-분석-segment-analysis">2. 하위군 분석 (Segment Analysis)</h1>

<p>많은 경우, 진행된 실험의 모집단에서 <strong>하위군 (subgroup)</strong> 별로 결과를 파악하고 싶은 경우가 발생할 수 있다. 구글 애널리틱스, Optimizely, 어도비 등 여러 실험 플랫폼들 대부분 하위군 분석을 지원하기는 하지만, 구체적인 결과가 어떤식으로 산출되는지에 대한 레퍼런스는 생각보다 많이 없었다. 따라서 해당 섹션에서는 일반적인 맥락에서 하위군 분석을 수행함에 있어 유의해야 할 점 몇 가지를 정리해보도록 하겠다.</p>

<p> </p>

<h2 id="2-1-segment-analysis의-분류">2-1. Segment Analysis의 분류</h2>

<p>하위군 분석은 그 목적에 따라 크게 다음의 두가지로 구분될 수 있다. 통계적 오류에 빠지지 않기 위해서는 이를 확실하게 구별하는 것이 중요하다.</p>

<p> </p>

<h4 id="a-exploratory-segment-analysis-탐색적-하위군-분석">(a) Exploratory Segment Analysis (탐색적 하위군 분석)</h4>

<p><strong>탐색적 하위군 분석</strong>이란, 다중 검정을 실시하지만 다중성을 보정하지 않는 하위군 분석을 의미한다. 사실 A/B Test에서 약 90%는 탐색적 하위군 분석이라고 봐도 무방할 것이다.</p>

<p>탐색적 하위군 분석의 가장 큰 목적은 다음의 질문에 대해 대답을 하기 위함이다.</p>

<blockquote>
  <p><strong>Q. treatment effect가 각 하위군 별로 일정한가?</strong></p>
</blockquote>

<p>사실 이를 알아보기 위한 가장 정확한 통계 방법은 ANOVA 모형을 바탕으로 interaction effect의 회귀 계수의 기울기가 $0$인지 아닌지 여부를 검정하는 것이지만, 많은 경우 플랫폼 사용자들이 통계 비전공자라는 점에서 이는 결과 해석의 혼란을 초래할 수 있다.</p>

<p>따라서 현실적인 대안으로, <a href="https://support.optimizely.com/hc/en-us/articles/4410284017421#Segment_experiment_results">optimizely</a> 등의 플랫폼에서는 UI 상에서 각 하위군들의 검정 결과에 대한 p-value를 명시적으로 제시하는 것은 지양하고, 신뢰구간으로 통계적 유의성만을 보여주는 방식을 채택하고 있다. 이는 플랫폼의 사용자가 하위군 분석 결과를 <strong>확증적으로 받아들이지 않도록 하기 위함</strong>이다.</p>

<center>
  <img src="/images/abtest/20.png" width="700" height="500" /> 
 <br />
 <em><span style="color:grey">Optimizely</span></em>
</center>

<p> </p>

<p>그렇다면 하위군 분석의 결과를 왜 신뢰할 수 없는지에 대한 이유 몇가지를 간략하게 기술하자면 다음과 같다:</p>

<ul>
  <li>다중 검정을 통해서 FWER이 증가할 수 있다.</li>
  <li>각 하위군에서는 무작위배정이 수행되지 않았다.</li>
  <li>각 하위군의 표본크기는 전체에 비해 적어져 검정력이 낮아진다.</li>
</ul>

<p> </p>

<h4 id="b-causal-segment-analysis-확증적-하위군-분석">(b) Causal Segment Analysis (확증적 하위군 분석)</h4>

<p>다음으로 <strong>확증적 하위군 분석</strong>이란, 특정 하위군에서 얻은 결과를 인과적인 결과로 받아들이고자 하는 경우를 의미합니다.</p>

<p>위와 같은 목적의 하위군 분석은 과거의 실험 등을 바탕으로 특정한 segment에서 treatment의 효과가 전체 집단과 매우 다를 것이라는 <strong>충분한 사전 증거</strong>가 있는 경우에 수행될 수 있습니다.</p>

<p>이를 위해서는 분석할 하위군을 실험의 기획단계에서 명시적으로 정의해야하며, 층화 무작위배정 (stratified randomization)을 바탕으로 실험이 진행되고, 실험이 끝난 뒤에는 Bonferroni 방법 등으로 다중성에 대한 보정을 하게됩니다.</p>

<p>이러한 확증적 하위군 분석은 실험 문화가 정착된 다음, user experience를 customer-funnel 에서의 단계별로 최적화 하고 싶은 니즈가 발생할 경우 (i.e. personalization) 진행될 수 있습니다. 따라서 현 상황에서 KART에 바로 적용하기는 무리가 있어보입니다.</p>

<p> </p>

<hr />

<p>러한 상황에서는 유의수준을 <strong>보정하지 않는 것</strong>을 원칙으로 하되, 실험의 결과를 인과적으로 받아들이지 않는 것에 대한 각별한 주의가 필요하다.</p>

<p>가령, 하위군 분석의 결과로 새로운 기능이 여성 그룹에서는 유의하지 않고 남성 그룹에서만 유의했을 경우, 해당 결과는 어디까지나 인사이트를 얻기 위한 참고 자료로만 활용되어야 한다. 만약 실제로 성별에 따라 효과에 차이가 있는지에 관심이 있는 경우에는 primary metric을 성별별 지표로 삼는 별도의 follow-up experiment를 진행해야 한다.</p>

<p>자 그렇다면 좀 더 구체적으로 해당 내용을 파헤쳐보도록 하겠다.</p>

:ET